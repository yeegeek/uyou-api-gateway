.PHONY: proto build test clean docker-build run doc
.PHONY: migrate-up migrate-down migrate-status

# ==================== é»˜è®¤é…ç½® ====================
# MongoDB é…ç½® (å¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–)
MONGO_HOST     ?= localhost
MONGO_PORT     ?= 27017
MONGO_USER     ?= root
MONGO_PASSWORD ?= example
MONGO_DATABASE ?= {{DB_NAME}}

# MongoDB è¿æ¥å­—ç¬¦ä¸²
MONGO_URL = mongodb://$(MONGO_USER):$(MONGO_PASSWORD)@$(MONGO_HOST):$(MONGO_PORT)/$(MONGO_DATABASE)?authSource=admin

# ==================== æ„å»ºç›¸å…³ ====================

# ç”Ÿæˆ Proto ä»£ç 
proto:
	protoc --go_out=. --go_opt=paths=source_relative \
	       --go-grpc_out=. --go-grpc_opt=paths=source_relative \
	       api/proto/*.proto

# æ„å»ºæœåŠ¡
build:
	go build -o bin/{{SERVICE_NAME}} cmd/server/main.go

# è¿è¡ŒæœåŠ¡
run:
	go run cmd/server/main.go

# çƒ­é‡è½½è¿è¡Œ (å¼€å‘æ¨¡å¼)
dev: check-air
	air

# æ£€æŸ¥ air æ˜¯å¦å®‰è£…
check-air:
	@command -v air > /dev/null || { \
		echo ""; \
		echo "âŒ air å·¥å…·æœªå®‰è£…"; \
		echo ""; \
		echo "è¯·å®‰è£… air (çƒ­é‡è½½å·¥å…·):"; \
		echo "  go install github.com/cosmtrek/air@latest"; \
		echo ""; \
		echo "æˆ–ä½¿ç”¨ brew (macOS):"; \
		echo "  brew install air"; \
		echo ""; \
		exit 1; \
	}

# æµ‹è¯•
test:
	go test -v ./...

# é›†æˆæµ‹è¯•
test-integration:
	go test -v -tags=integration ./...

# æ¸…ç†
clean:
	rm -rf bin/

# Docker æ„å»º (ç”Ÿäº§é•œåƒ)
docker-build:
	docker build -t {{SERVICE_NAME}}:latest .

# Docker å¼€å‘æ¨¡å¼ (çƒ­é‡è½½)
docker-dev:
	docker compose -f docker-compose.dev.yml up --build

# Docker å¼€å‘æ¨¡å¼ (åå°è¿è¡Œ)
docker-dev-d:
	docker compose -f docker-compose.dev.yml up --build -d

# åœæ­¢ Docker å¼€å‘ç¯å¢ƒ
docker-dev-down:
	docker compose -f docker-compose.dev.yml down

# æŸ¥çœ‹ Docker å¼€å‘ç¯å¢ƒæ—¥å¿—
docker-dev-logs:
	docker compose -f docker-compose.dev.yml logs -f {{SERVICE_NAME}}

# ==================== æ•°æ®åº“è¿ç§» (MongoDB) ====================

# æ£€æŸ¥ mongosh æ˜¯å¦å®‰è£…
check-mongosh:
	@command -v mongosh > /dev/null || { \
		echo ""; \
		echo "âŒ mongosh å·¥å…·æœªå®‰è£…"; \
		echo ""; \
		echo "è¯·å®‰è£… mongosh:"; \
		echo "  brew install mongosh  (macOS)"; \
		echo "  æˆ–ä» https://www.mongodb.com/try/download/shell ä¸‹è½½"; \
		echo ""; \
		exit 1; \
	}

# æ‰§è¡Œæ‰€æœ‰è¿ç§»
migrate-up: check-mongosh
	@echo "ğŸ”¼ æ‰§è¡Œ MongoDB è¿ç§»..."
	@for file in migrations/*.js; do \
		if [[ ! "$$file" == *".down.js" ]]; then \
			echo "æ‰§è¡Œ: $$file"; \
			mongosh "$(MONGO_URL)" < "$$file"; \
		fi; \
	done
	@echo "âœ… è¿ç§»å®Œæˆ"

# å›æ»šè¿ç§»
migrate-down: check-mongosh
	@echo "ğŸ”½ æ‰§è¡Œ MongoDB å›æ»š..."
	@echo ""
	@echo "å¯ç”¨çš„å›æ»šè„šæœ¬:"
	@ls -la migrations/*.down.js 2>/dev/null | awk '{print "   " NR ". " $$NF}' || echo "   (æ— å›æ»šè„šæœ¬)"
	@echo ""
	@read -p "è¾“å…¥è¦æ‰§è¡Œçš„å›æ»šè„šæœ¬æ–‡ä»¶å: " file; \
	if [ -f "$$file" ]; then \
		mongosh "$(MONGO_URL)" < "$$file"; \
		echo "âœ… å›æ»šå®Œæˆ"; \
	else \
		echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $$file"; \
	fi

# æŸ¥çœ‹è¿ç§»çŠ¶æ€
migrate-status:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘     MongoDB è¿ç§»çŠ¶æ€                   â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ“ è¿ç§»è„šæœ¬:"
	@ls -la migrations/*.js 2>/dev/null | awk '{print "   " $$NF}' || echo "   (æ— è¿ç§»æ–‡ä»¶)"
	@echo ""
	@echo "ğŸ“Š å½“å‰ç´¢å¼•:"
	@mongosh "$(MONGO_URL)" --quiet --eval "db.{{TABLE_NAME}}.getIndexes().forEach(function(i){print('   - ' + i.name)})" 2>/dev/null || echo "   (æ— æ³•è¿æ¥æ•°æ®åº“)"
	@echo ""

# åˆ›å»ºæ–°çš„è¿ç§»è„šæœ¬
migrate-create:
	@echo ""
	@echo "ğŸ“ åˆ›å»ºæ–°çš„è¿ç§»è„šæœ¬"
	@echo ""
	@read -p "è¿ç§»åç§° (ä¾‹å¦‚: add_email_index): " name; \
	if [ -z "$$name" ]; then \
		echo "âŒ è¿ç§»åç§°ä¸èƒ½ä¸ºç©º"; \
		exit 1; \
	fi; \
	seq=$$(ls -1 migrations/*.js 2>/dev/null | wc -l | tr -d ' '); \
	seq=$$((seq / 2 + 1)); \
	seq=$$(printf "%06d" $$seq); \
	echo "// Migration: $$name" > "migrations/$${seq}_$${name}.js"; \
	echo "// Created: $$(date)" >> "migrations/$${seq}_$${name}.js"; \
	echo "" >> "migrations/$${seq}_$${name}.js"; \
	echo "db = db.getSiblingDB('{{DB_NAME}}');" >> "migrations/$${seq}_$${name}.js"; \
	echo "" >> "migrations/$${seq}_$${name}.js"; \
	echo "// TODO: Add migration logic here" >> "migrations/$${seq}_$${name}.js"; \
	echo "" >> "migrations/$${seq}_$${name}.js"; \
	echo "// Rollback script" > "migrations/$${seq}_$${name}.down.js"; \
	echo "db = db.getSiblingDB('{{DB_NAME}}');" >> "migrations/$${seq}_$${name}.down.js"; \
	echo "" >> "migrations/$${seq}_$${name}.down.js"; \
	echo "// TODO: Add rollback logic here" >> "migrations/$${seq}_$${name}.down.js"; \
	echo ""; \
	echo "âœ… å·²åˆ›å»ºè¿ç§»æ–‡ä»¶:"; \
	echo "   migrations/$${seq}_$${name}.js"; \
	echo "   migrations/$${seq}_$${name}.down.js"

# ==================== æ–‡æ¡£ç”Ÿæˆ ====================

# ç”Ÿæˆ API æ–‡æ¡£
doc:
	@if command -v protoc-gen-doc > /dev/null; then \
		protoc --doc_out=./docs --doc_opt=markdown,api.md api/proto/*.proto; \
		echo "âœ… API æ–‡æ¡£å·²ç”Ÿæˆ: docs/api.md"; \
	elif command -v buf > /dev/null; then \
		buf generate --template buf.gen.doc.yaml; \
		echo "âœ… API æ–‡æ¡£å·²ç”Ÿæˆ"; \
	else \
		echo "âš ï¸  æœªæ‰¾åˆ°æ–‡æ¡£ç”Ÿæˆå·¥å…·"; \
		echo "   å®‰è£… protoc-gen-doc: go install github.com/pseudomuto/protoc-gen-doc/cmd/protoc-gen-doc@latest"; \
		echo "   æˆ–å®‰è£… buf: https://buf.build/docs/installation"; \
	fi

# ==================== å¸®åŠ© ====================

help:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘   {{SERVICE_TITLE}} Service - å¯ç”¨å‘½ä»¤           â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "æ„å»ºç›¸å…³:"
	@echo "  make proto          ç”Ÿæˆ Proto ä»£ç "
	@echo "  make build          æ„å»ºæœåŠ¡"
	@echo "  make run            è¿è¡ŒæœåŠ¡"
	@echo "  make dev            æœ¬æœºçƒ­é‡è½½è¿è¡Œ"
	@echo "  make test           è¿è¡Œæµ‹è¯•"
	@echo "  make docker-build   æ„å»ºç”Ÿäº§é•œåƒ"
	@echo "  make docker-dev     Docker çƒ­é‡è½½è¿è¡Œ"
	@echo "  make docker-dev-d   Docker çƒ­é‡è½½è¿è¡Œ (åå°)"
	@echo "  make docker-dev-down  åœæ­¢ Docker å¼€å‘ç¯å¢ƒ"
	@echo "  make docker-dev-logs  æŸ¥çœ‹å¼€å‘ç¯å¢ƒæ—¥å¿—"
	@echo ""
	@echo "æ•°æ®åº“è¿ç§» (MongoDB):"
	@echo "  make migrate-up        æ‰§è¡Œæ‰€æœ‰è¿ç§»"
	@echo "  make migrate-down      å›æ»šè¿ç§»"
	@echo "  make migrate-status    æŸ¥çœ‹è¿ç§»çŠ¶æ€"
	@echo "  make migrate-create    åˆ›å»ºæ–°çš„è¿ç§»è„šæœ¬"
	@echo ""
	@echo "å…¶ä»–:"
	@echo "  make doc            ç”Ÿæˆ API æ–‡æ¡£"
	@echo "  make clean          æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  make help           æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
